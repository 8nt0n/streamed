<!DOCTYPE html>
<html>
    <head>
        <title>streamed</title>
        
        <meta charset="utf-8">
        
        <!-- streamed style -->
        <link rel="stylesheet" href="style.css">

        <!--font-->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">


        <!-- icon -->
        <link rel="icon" type="image/png" href="src/logo.png">

        <!-- model -->
        <script src="data.js"></script>
    </head>



    <body class="disable-scrollbars">

        <div id="playerBg" class="playerhidden">
            <div id="closePlayerOverlay" class="close-player-overlay clickable clickable-text-div" onclick="hide_player();">
                <span>x</span>
            </div>

            <div id="video" class="video-player-container fullsize-panel">
                <video id="player" width="90%" height="60%" class="video-player" controls></video>

                <div id="seasonBorder" class="season-border">
                    <div id="seasonContainer" class="season-container"></div>
                </div>
                <p id="movieTitle" class="movie-title"></p>
            </div>
            <div id="descriptionDiv" class="description-container">
                <p id="movieDescription" class="movie-description"></p>
            </div>
            
        </div>


        <div id="siteContainer" class="site-container">

            <!-- top bar -->
            <div id="topBar" class="top-bar">
                <p class="top-bar-title clickable" onclick="location.reload();">Streamed</p>
                
                <div id="searchbarContainer" class="searchbar-container">
                    <button id="filterByTypeMovieBtn" class="movies-filter filter-by-type clickable" onclick="filterByType('Movies');">Movies</button>
                    <button id="filterByTypeSeriesBtn" class="series-filter filter-by-type clickable" onclick="filterByType('Series');">Series</button>
                    <button id="filterByTypeAudioBtn" class="audios-filter filter-by-type clickable" onclick="filterByType('Audios');">Audios</button>
                    
                    <button id="toggleFilterModeBtn" class="toggle-filter-mode clickable" onclick="searchiconclicked();">
                        <img src="src/search.svg" width="30" height="30">
                    </button>

                    <!-- filter -->
                    <div id="filterInputContainer" class="filter-input-container"> 
                        <input id="filterInput" placeholder="Search" type="text" onkeyup="filterByTextMatch(this.value);">
                    </div>
                </div>

                <div id="profile-wrapper" class="clickable" onclick="location.reload();">
                    <img src="src/home.png" height="30">
                </div>
            </div>



            <!-- Top pick -->
            <div id="topPick" class="top-pick-container">
                
                <!--pick1-->
                <div id="topPick1" class="top-pick clickable clickable-movie" onclick="spawnPlayer(randomMovie)">
                    <div class="top-pick-title-container">
                        <p id="topPickTitle1" class="top-pick-title"></p>
                    </div>
                    <div class="top-pick-play">
                        <img id="topPickPlayMovie1" src="src/Play_Movie.svg">
                    </div>
                </div>
                
                <!--pick2-->
                <div id="topPick2" class="top-pick clickable clickable-movie" onclick="spawnPlayer(randomMovie2)">
                    <div class="top-pick-title-container">
                        <p id="topPickTitle2" class="top-pick-title"></p>
                    </div>
                    <div class="top-pick-play">
                        <img id="topPickPlayMovie2" src="src/Play_Movie.svg">
                    </div>
                </div>
            </div>
 

            <!-- Main panel for media listing -->
            <div id="rootContainer" class="main"></div>

        </div>
    </body>

    <script>
        const FILTER_MODE_TYPE = 0;
        const FILTER_MODE_TEXT = 1;

        // initial filter mode:
        let filterMode = FILTER_MODE_TYPE; //Search bar is showing "Movies | Series | Audios"

        // some HTML elements:
        let siteContainer = document.getElementById("siteContainer");
        let playerBg = document.getElementById("playerBg");
        let player = document.getElementById("player");
        let playerTitle = document.getElementById("movieTitle");
        let playerDescription = document.getElementById("movieDescription");
        let videoContainer = document.getElementById("video");
        let seasonContainer = document.getElementById("seasonContainer");
        let topPick = document.getElementById("topPick");
        let filterInputContainer = document.getElementById("filterInputContainer");
        let filterInputElem = document.getElementById("filterInput");
     
        // randomly selected movies for the 'top pick':
        let randomMovie;
        let randomMovie2;

        
        /*
                 _______________
              //~~~~~~~~~~~~~~~\\  |
         0  / /_________________\ \| 0
          ---------------------------
        / /======|=D=O=D=G=E=|======\ \
        \_____________________________/
        \    _______       _______    /
        |\ _/|__|__|\_____/|__|__|\_ /|
        |      |`V'  `---'  `V'|      |
        |______|               |______|
       
        */

        // other cars <<<<<<< dodge charger


        let isColorCloseToWhite = function (hex) {
            hex = hex.replace(/^#/, "");
            if (hex.length === 3) {
              hex = hex.split("").map(c => c + c).join("");
            }
            if (hex.length !== 6) return false;
          
            const r = parseInt(hex.slice(0, 2), 16);
            const g = parseInt(hex.slice(2, 4), 16);
            const b = parseInt(hex.slice(4, 6), 16);
          
            const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
            return brightness > 220;
        }

        
        let initTopPick = function(movieObj, topPickNum) {
            console.log(`initializing top pick ${topPickNum}: '${movieObj.title}'...`);

            let topPickElem = document.getElementById("topPick" + topPickNum);
            topPickElem.style = `background-image: url('media/${movieObj.type}/${movieObj.path}/meta/${movieObj.thumbnailFile}'); background-color: ${movieObj.thumbColor};`;

            let topPickTitle = document.getElementById("topPickTitle" + topPickNum);
            topPickTitle.innerText = movieObj.title
            if (isColorCloseToWhite(movieObj.thumbColor)) {
                topPickTitle.style.color = "black";
                document.getElementById("topPickPlayMovie" + topPickNum).src = "src/Play_Movie_dark.svg";
            } else {
                topPickTitle.style.color = "white";
            }

            // FIXME: the 'fade' div is currently not properly rendered:
            let topPickFade = document.createElement("div")
            topPickFade.setAttribute("class", "fullsize-panel");
            topPickFade.style = `background: linear-gradient(to right, ${movieObj.thumbColor} 0%, ${movieObj.thumbColor} 55%, #ffffff00 100%);`;
            topPickElem.appendChild(topPickFade);
        }
          

        let chooseTopPick = function(Movies) {
            // Top Picks
            initTopPick(randomMovie, 1);
            initTopPick(randomMovie2, 2);
        }


        let toggleFilterMode = function(filterButtonsDisplayStyle, filterInputDisplayStyle) {
                // hide/show filter buttons
                document.querySelectorAll(".searchbar-container button.filter-by-type").forEach(
                    (btn) => btn.style.display = filterButtonsDisplayStyle
                );

                // hide/show searchbar
                filterInputElem.style.display = filterInputDisplayStyle;
                filterInputContainer.style.display = filterInputDisplayStyle;
        }

        let searchiconclicked = function() {
            if (filterMode === FILTER_MODE_TYPE) {
                //extract searchbar
                toggleFilterMode("none", "block");
                filterMode = FILTER_MODE_TEXT;
            } else if (filterMode === FILTER_MODE_TEXT) {
                //contract searchbar
                toggleFilterMode("block", "none");
                filterMode = FILTER_MODE_TYPE;
            }
        }



        let spawnEpisodes = function(summary, seasonNum) {
            let maxEpisodeIdx = summary.seasonEp[seasonNum - 1]
            
            seasonContainer.innerHTML = "";
//            seasonContainer.style = "height: 92%; width: 95%; display: grid; grid-gap: 6px; grid-template-rows: 9fr 1fr; padding: 12px;"
            seasonContainer.setAttribute("class", "season-container");
//            document.getElementById('seasonBorder').style = "margin-top: 60px; height: 70%; width: 90%; border-radius: 5px; border: 1px solid rgba( 255, 255, 255, 0.18 ); overflow: auto; max-height: 800px;"
//            document.getElementById('seasonBorder').setAttribute("class", "season-border");

            let episodePlayer = document.createElement("video");
            episodePlayer.setAttribute("controls", "");                
            episodePlayer.style = "width: 90%; margin-top: 5%; border-radius: 6;"

            seasonContainer.appendChild(episodePlayer);

            let episodeSelect = document.createElement("select");
            seasonContainer.appendChild(episodeSelect);

            let optGroup = document.createElement("optgroup");
            optGroup.label = "Staffel " + seasonNum;
            episodeSelect.appendChild(optGroup);

            for (let i = 0; i < maxEpisodeIdx; i++) {

                // let playerContainer = document.createElement("div")
                // playerContainer.style = "width: 100%; height: 300px; border: 1px solid rgba( 255, 255, 255, 0.18 ); border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(16px) saturate(180%); webkt-backdrop-filter: blur(16px) saturate(180%); background-color: rgba(17, 25, 40, 0.75); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.125)"

                // let episodeInfo = document.createElement("p")
                // let EpisodeNumber = i + 1 
                // episodeInfo.innerHTML = "Staffel " + episodesCount + " | Episode " + EpisodeNumber
                // episodeInfo.style = "font-weight: 200; font-size: 1.2rem; color: rgba(110, 110, 110, 1); text-align: left;"

                // seasonContainer.appendChild(playerContainer);
                // playerContainer.appendChild(episodeInfo);

                let episodeOption = document.createElement("option");
                episodeOption.value = `media/${summary.type}/${summary.path}/${seasonNum}/${i+1}`;
                episodeOption.innerText = "Episode " + (i + 1);
                optGroup.appendChild(episodeOption);
            }

            episodeSelect.addEventListener("change", (evt) => {
                console.dir(evt);

                let episodePath = evt.srcElement.selectedOptions[0].value;      
                console.log(episodePath);

                episodePlayer.src = episodePath + ".mp4"; // TODO: get the filename from the model
                episodePlayer.onerror = function() {
                    episodePlayer.src = episodePath + ".mkv";
                };
            });

            episodeSelect.selectedIndex = 0;
            episodeSelect.dispatchEvent(new Event('change', { 'view': window, 'bubbles': true }));
        }



        let spawnPlayer = function(summary) {
            console.log(summary.type)

            hide_player()

            siteContainer.style.display = "none"
            playerBg.setAttribute('class', 'player');

            const seasonBorder = document.getElementById('seasonBorder');
            if (summary.type == "movies") {
                seasonContainer.style.display = "none"
                seasonBorder.style.display = "none"
                player.src = 'media/' + summary.type + '/' + summary.path + '/' + summary.file;                
            } else if (summary.type == "series") {
//                seasonContainer.style = "height: 150%; width: 95%; display: grid; grid-gap: 1%; grid-template-columns: 1fr 1fr 1fr 1fr; padding: 2%;"
                seasonContainer.style.display = "block"
                seasonBorder.style.display = "block"
                player.style.display = "none"



                /*
                for(let i=0; i < summary.seasons; i++){
                    let cover = document.createElement("img");
                    const seasonNum = i + 1;
                    cover.src = `media/${summary.type}/${summary.path}/meta/${seasonNum}.jpg`
                    cover.setAttribute("id", seasonNum)
                    cover.setAttribute("alt", "Staffel " + (seasonNum));
                    cover.setAttribute("class", "SeasonCover");
                    cover.setAttribute("onclick", `spawnEpisodes(${JSON.stringify(summary)}, ${seasonNum})`);
                    seasonContainer.appendChild(cover);
                }
                */
                // TODO: create a (nice!) single selection element containing all of the episodes of all of the seasons
                for (let i = 0; i < summary.seasons; i++) {
                    let cover = document.createElement("img");
                    const seasonNum = i + 1;
                    cover.src = `media/${summary.type}/${summary.path}/meta/${seasonNum}.jpg`
                    cover.setAttribute("id", seasonNum)
                    cover.setAttribute("alt", "Staffel " + (seasonNum));
                    cover.setAttribute("class", "SeasonCover");
                    cover.setAttribute("onclick", `spawnEpisodes(${JSON.stringify(summary)}, ${seasonNum})`);
                    seasonContainer.appendChild(cover);
                }


                
            }

            playerTitle.innerHTML = summary.title;
            videoContainer.appendChild(playerTitle);
            
            playerDescription.innerHTML = summary.description;
            document.getElementById("descriptionDiv").appendChild(playerDescription);
        }

        // Thanks chat gpt duh?
        function getVideoResolution(resolutionString) {
            if (resolutionString == "[n/a]") {
                return 'Unknown Resolution';
            }

            // Extract numbers from input like "1920x1080", "1280x720 px", etc.
            const match = resolutionString.match(/(\d+)\s*x\s*(\d+)/i);
            if (!match) return 'Unknown Resolution'; // = Invalid input
          
            let width = parseInt(match[1], 10);
            let height = parseInt(match[2], 10);
          
            // Normalize for landscape orientation
            const w = Math.max(width, height);
            const h = Math.min(width, height);
          
            // aint nobody hoarding 16k 40tb .mp4 files bro
            if (h >= 4300) return 'res_8k'; 
            if (h >= 2100) return 'res_4k';
            if (h >= 1400) return 'res_1440p';
            if (h >= 1000) return 'res_1080p';
            if (h >= 700) return 'res_720p';
            if (h < 700) return 'Unknown Resolution';
          
            return 'Unknown Resolution';
        }          
          

        let createDiv = function(summary) {
            // parent div            
            let mediaListElem = document.createElement("div");
            mediaListElem.setAttribute('class', `media-item clickable clickable-movie ${summary.type} ${summary.path}`); // note: 'type' and 'path' is used for filtering
            mediaListElem.setAttribute('onclick', `spawnPlayer(${JSON.stringify(summary)})`);

            // thumbnail div
            const thumbnailPath = "media/" + summary.type + "/" + summary.path + "/meta/" + summary.thumbnailFile;
            let mediaThumbnailElem = document.createElement("div");
            mediaThumbnailElem.setAttribute("class", "listitem-thumbnail-panel");
            mediaThumbnailElem.setAttribute("style", `background-image: url('${thumbnailPath}');`);
            mediaListElem.appendChild(mediaThumbnailElem);

            // title paragraph
            let mediaTitleElem = document.createElement("p");
            mediaTitleElem.setAttribute("class", "listitem-title-panel");
            mediaTitleElem.innerText = summary.title;
            mediaListElem.appendChild(mediaTitleElem);


            // details
            let mediaDetailsElem = document.createElement("p");
            mediaDetailsElem.setAttribute("class", "listitem-details-panel");
            if (summary.type === "series") {
                // number of seasons and total episodes count
                mediaDetailsElem.innerText = `${summary.seasons} Season${(summary.seasons === "1" ? "" : "s")} | ${summary.episodes} Episodes`;
            } else if (summary.type === "movies") {
                // movie length and resolution
                mediaDetailsElem.innerText = `${summary.resolution} | ${summary.length}`;

                // resolution icon
                let videoResolution = getVideoResolution(summary.resolution);
                console.log(`${summary.resolution} >>> ${videoResolution}`);

                if (videoResolution !== "Unknown Resolution") {
                    let resolutionIconElem = document.createElement("img");
                    resolutionIconElem.src = `src/${videoResolution}.png`;
                    resolutionIconElem.setAttribute("class", "listitem-resolution-icon");
                    mediaThumbnailElem.appendChild(resolutionIconElem);
                }
            }
            mediaListElem.appendChild(mediaDetailsElem);

            document.getElementById('rootContainer').appendChild(mediaListElem);
        }


        let hide_player = function() {
            siteContainer.style.display = "grid"
            player.pause()
            playerBg.setAttribute('class', 'playerhidden');
            player.style.display = "inline-block";
            seasonContainer.innerHTML = '';
        }


        let loaded = function() {
            console.log('loaded');

            for (let i = 0; i < Movies.length; i++) {
                createDiv(Movies[i]);
            }

            for (let i = 0; i < Series.length; i++){
                createDiv(Series[i]);
            }

            filterInputElem.style.display = "none";
            filterInputElem.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    filterMode = FILTER_MODE_TEXT;
                    searchiconclicked();
                }
            });


            if (Movies.length > 1) {
                do {
                    randomMovie = Movies[Math.floor(Math.random() * Movies.length)];
                    randomMovie2 = Movies[Math.floor(Math.random() * Movies.length)];
                } while (randomMovie === randomMovie2);
            } else {
                randomMovie = Movies[0];
                randomMovie2 = Movies[0];
            }
            chooseTopPick(Movies)

            
            //fancy for if(esc pressed){hide player}
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' || event.key === 'Esc') {
                    hide_player()
                }
            });
        }
        

        let filterByTextMatch = function(value) {
            console.log('filtering by ' + value);
            
            if (value.length === 0) {
                resetFilter();
                return;
            }
            
            const lowValue = value.toLowerCase();
            
            for (let movie of Movies) {
                if (movie.title.toLowerCase().indexOf(lowValue) === -1) {
                    document.querySelector("." + movie.path).style.display = "none";
                }
            }

            for (let serie of Series){
                if (serie.title.toLowerCase().indexOf(lowValue) === -1) {
                    document.querySelector("." + serie.path).style.display = "none";
                }
            }
        }
        
        let resetFilter = function() {
            for (let mediaItem of document.querySelectorAll(".media-item")) {
                mediaItem.style.display = "block";
            }
        }


        let filterByType = function(Type) {
            // TODO: make it possible to also reset these 'by type' filters:
            
            if (Type == "Movies") {

                document.getElementById("filterByTypeMovieBtn").style.color = "white"
                document.getElementById("filterByTypeSeriesBtn").style.color = "#CACACA"
                document.getElementById("filterByTypeAudioBtn").style.color = "#CACACA"

                for (let mediaItem of document.querySelectorAll(".media-item")) {
                    mediaItem.style.display = "block";
                }

//                for (let serie of Series) {
//                    document.querySelector("." + serie.path).style.display = "none";
//                }
                for (let series of document.querySelectorAll(".series")) {
                    series.style.display = "none";
                }
            }
            
            if (Type == "Series") {

                document.getElementById("filterByTypeMovieBtn").style.color = "#CACACA"
                document.getElementById("filterByTypeSeriesBtn").style.color = "white"
                document.getElementById("filterByTypeAudioBtn").style.color = "#CACACA"

                for (let mediaItem of document.querySelectorAll(".media-item")) {
                    mediaItem.style.display = "block";
                }

//                for (let movie of Movies) {
//                    document.querySelector("." + movie.path).style.display = "none";
//                }
                for (let series of document.querySelectorAll(".movies")) {
                    series.style.display = "none";
                }
            }

            // TODO: Audios
            /*
            if (Type == "Audios") {
                for (let movie of Movies) {
                    document.querySelector("." + movie.path).style.display = "none";
                }
                for (let serie of Series) {
                    document.querySelector("." + serie.path).style.display = "none";  
                }

            }
            */

        }


        // start rendering UI
        loaded();


    </script>


</html>