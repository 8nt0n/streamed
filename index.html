<!DOCTYPE html>
<html>
    <head>
        <title>streamed</title>
        
        <meta charset="utf-8">
        
        <link rel="stylesheet" href="style.css">
        <!--Font-->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">


        <!--icon-->
        <link rel="icon" type="image/png" href="src/logo.png">
        <script src="data.js"></script>
    </head>

    <body class="disable-scrollbars">

        <div id="playerBg" class="playerhidden">
            <div style="position: absolute; top: 12px; left: calc(100% - 45px);">
                <button onclick="hide_player();" class="Close-button">
                    <img src="src/close.PNG" alt="close" style="width: 100%;">
                </button>

            </div>

            <div id="video" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: top; flex-direction: column;">
                <video width="90%" height="60%"  controls id="player" style="border-radius: 15px; background-color: black; margin-top: 60px;"></video>
                <div id="SeasonBorder" style="margin-top: 60px; height: 70%; width: 90%; border-radius: 5px; border: 1px solid rgba( 255, 255, 255, 0.18 ); overflow: auto; max-height: 800px;">
                    <div id="SeasonContainer" style="height: 300%; width: 95%; display: grid; grid-gap: 1%; grid-template-columns: 1fr 1fr 1fr 1fr; grid-template-rows: 600px 600px 600px 600px 600px 600px 600px 600px 600px; padding: 2%;"></div>
                </div>
                <p style="font-weight: 800; text-shadow: 0px 0px 3px white; font-size: 2rem;" id="movieTitle"></p>
            </div>
            <div id="descriptionDiv" style="width: 100%; height: 80%; display: flex; align-items: top; justify-content: top; margin: 10% 0%; margin-top: 15%;" >
                <p id="description" style="font-weight: 200; font-size: 1.2rem; color: rgb(58, 58, 58); text-align: left; margin: 5%; margin-bottom: 100px;"></p>
            </div>
            
        </div>

        <div class="site-container" id="site-container">

            <!--top bar stuff-->
            <div style="height: 100%; width: 100%; display: flex; align-items: center; justify-content: space-between;">
                <p style="font-family: Poppins; font-size: 2rem; margin: 0px; margin-left: 40px; cursor: pointer;" onclick="location.reload();">Streamed</p>
                
                <div id="searchbar-wrapper">
                    <button style="top: 9px; left: 10px;" class="searchbar_button" id="searchbar_button_movies" onclick="filterType('Movies')">Movies</button>
                    <button style="top: 9px; left: 75px;" class="searchbar_button" id="searchbar_button_series" onclick="filterType('Series')">Series</button>
                    <button style="top: 9px; left: 130px;" class="searchbar_button" id="searchbar_button_audios" onclick="filterType('Audios')">Audios</button>
                    
                    <button style="background-color: #1B2733; border: 0px; width: 32px; height: 32px; border-radius: 20px; display: flex; align-items: center; justify-content: center; right: 4px; top: 4px; margin: 0px; position: absolute; cursor: pointer;" onclick="searchiconclicked()">
                        <img src="src/search.svg" style="height: 30px; width: 30px;">
                    </button>

                    <!-- filter -->
                    <div id="filterDiv" style="height: 100%; width: 190px;"> 
                        <input id="filterInput" placeholder="Search" type="text" onkeyup="filter(this.value);">
                    </div>
                </div>

                <div id="profile-wrapper" onclick="location.reload();">
                    <img src="src/home.png" style="height: 30px; cursor: pointer;">
                </div>
            </div>



            <!--Top pick-->
            <div style="height: 100%; width: 100%; display: flex; align-items: center; justify-content: center;" id="topPick">
                
                <!--pick1-->
                <div id="topPick1" class="toppick" onclick="spawnPlayer(randomMovie)">
                    <p class="TopPickTitle" id="TopPickTitle1">Disnep - Kang Satay</p>

                    <img src="src/Play_Movie.svg" class="Top_Pick_Play_Movie" id="Top_Pick_Play_Movie1">
                    
                </div>
                
                
                <!--pick2-->
                <div id="topPick2" class="toppick" onclick="spawnPlayer(randomMovie2)">
                    <p class="TopPickTitle" id="TopPickTitle2">Disnep - Gaja Langka</p>

                    <img src="src/Play_Movie.svg" class="Top_Pick_Play_Movie" id="Top_Pick_Play_Movie2">
                    
                </div>
            </div>
            

            <!--top bar stuff-->
            <div style="height: 100%; width: 100%;">
                <p></p>
            </div>


            
            <div id="rootContainer" class="main">
                
                
            </div>
            

        </div>

    </body>

    <script>
        let search_bar_mode = 0; //Search bar is showing "Movies | Series | Audios"
        let playerBg = document.getElementById('playerBg');
        let player = document.getElementById('player');
        let playerTitle = document.getElementById('movieTitle');
        let playerDescription = document.getElementById('description');
        let videoContainer = document.getElementById('video');
        let seasonContainer = document.getElementById('SeasonContainer');
        let topPick = document.getElementById('topPick')
        let SearchbarElem = document.getElementById("filterInput")
        let SearchbarElem2 = document.getElementById("filterDiv")
        SearchbarElem.style.display = "none"


        let randomMovie
        let randomMovie2
        if (Movies.length > 1) {
            do {
                randomMovie = Movies[Math.floor(Math.random() * Movies.length)];
                randomMovie2 = Movies[Math.floor(Math.random() * Movies.length)];
            } while (randomMovie === randomMovie2);
        } else {
            randomMovie = Movies[0];
            randomMovie2 = Movies[0];
        }
        
        
        /*
                 _______________
              //~~~~~~~~~~~~~~~\\  |
           0  / /_________________\ \| 0
            ---------------------------
        / /======|=D=O=D=G=E=|======\ \
        \_____________________________/
        \    _______       _______    /
        |\ _/|__|__|\_____/|__|__|\_ /|
        |      |`V'  `---'  `V'|      |
        |______|               |______|
       
        */

        // other cars <<<<<<< dodge charger


        function isColorCloseToWhite(hex) {
            hex = hex.replace(/^#/, "");
            if (hex.length === 3) {
              hex = hex.split("").map(c => c + c).join("");
            }
            if (hex.length !== 6) return false;
          
            const r = parseInt(hex.slice(0, 2), 16);
            const g = parseInt(hex.slice(2, 4), 16);
            const b = parseInt(hex.slice(4, 6), 16);
          
            const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
            return brightness > 220;
          }
          

        let chooseTopPick = function(Movies) {

            // 1. Top Pick
            let TopPick = document.getElementById("topPick1")

            

            console.log(randomMovie)

            // TODO: actually do stuff with that movie

            TopPick.style = `background-image: url('media/${randomMovie.type}/${randomMovie.path}/meta/${randomMovie.thumbnailFile}'); background-color: ${randomMovie.thumbColor};`

            let TopPickTitle = document.getElementById("TopPickTitle1")

            if (isColorCloseToWhite(randomMovie.thumbColor)) {
                TopPickTitle.style.color = "black"
                document.getElementById("Top_Pick_Play_Movie1").src = "src/Play_Movie_dark.svg"
            }
            else {
                TopPickTitle.style.color = "white"
            }

            TopPickTitle.innerHTML = randomMovie.title

            let TopPickFade = document.createElement("div")
            TopPickFade.style = `width: 100%; height: 100%; background: linear-gradient(to right, ${randomMovie.thumbColor} 0%, ${randomMovie.thumbColor} 55%, #ffffff00 100%);`

            TopPick.appendChild(TopPickFade)

            // 2. Top Pick
            TopPick = document.getElementById("topPick2")

            

            console.log(randomMovie2)

            // TODO: actually do stuff with that movie

            TopPick.style = `background-image: url('media/${randomMovie2.type}/${randomMovie2.path}/meta/${randomMovie2.thumbnailFile}'); background-color: ${randomMovie2.thumbColor};`

            TopPickTitle = document.getElementById("TopPickTitle2")


            if (isColorCloseToWhite(randomMovie2.thumbColor)) {
                TopPickTitle.style.color = "black"
                document.getElementById("Top_Pick_Play_Movie2").src = "src/Play_Movie_dark.svg"
            }
            else {
                TopPickTitle.style.color = "white"
            }
            TopPickTitle.innerHTML = randomMovie2.title

            TopPickFade = document.createElement("div")
            TopPickFade.style = `width: 100%; height: 100%; background: linear-gradient(to right, ${randomMovie2.thumbColor} 0%, ${randomMovie2.thumbColor} 55%, #ffffff00 100%);`

            TopPick.appendChild(TopPickFade)
            
        };

        let searchiconclicked = function() {
            if (search_bar_mode == 0) {
                //extract searchbar


                // hide all buttons
                const elements = document.querySelectorAll('.searchbar_button');
                elements.forEach(function(element) {
                    element.style.display = 'none';
                });

                //show searchbar
                SearchbarElem.style.display = "block"
                SearchbarElem2.style.display = "block"

                search_bar_mode = 1
            }
            else if (search_bar_mode == 1) {
                //contract searchbar

                // show all buttons
                const elements = document.querySelectorAll('.searchbar_button');
                elements.forEach(function(element) {
                    element.style.display = 'block';
                });

                //hide searchbar
                SearchbarElem.style.display = "none"
                SearchbarElem2.style.display = "none"

                search_bar_mode = 0
            }
        }

        SearchbarElem.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                search_bar_mode = 1
                searchiconclicked()
            }
        });

        let spawnEpisodes = function(summary, seasonNum) {
            let maxEpisodeIdx = summary.seasonEp[seasonNum - 1]
            
            seasonContainer.innerHTML = ""
            // seasonContainer.style = "height: 150%; width: 95%; display: grid; grid-gap: 1%; grid-template-columns: 1fr 1fr; padding: 2%;"
            seasonContainer.style = "height: 92%; width: 95%; display: grid; grid-gap: 6px; grid-template-rows: 9fr 1fr; padding: 12px;"
            document.getElementById('SeasonBorder').style = "margin-top: 60px; height: 70%; width: 90%; border-radius: 5px; border: 1px solid rgba( 255, 255, 255, 0.18 ); overflow: auto; max-height: 800px;"

            let episodePlayer = document.createElement("video");
            episodePlayer.setAttribute("controls", "");                
            episodePlayer.style = "width: 90%; margin-top: 5%; border-radius: 6;"

            seasonContainer.appendChild(episodePlayer);

            let episodeSelect = document.createElement("select");
            seasonContainer.appendChild(episodeSelect);

            let optGroup = document.createElement("optgroup");
            optGroup.label = "Staffel " + seasonNum;
            episodeSelect.appendChild(optGroup);

            for (let i = 0; i < maxEpisodeIdx; i++) {

                // let playerContainer = document.createElement("div")
                // playerContainer.style = "width: 100%; height: 300px; border: 1px solid rgba( 255, 255, 255, 0.18 ); border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(16px) saturate(180%); webkt-backdrop-filter: blur(16px) saturate(180%); background-color: rgba(17, 25, 40, 0.75); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.125)"

                // let episodeInfo = document.createElement("p")
                // let EpisodeNumber = i + 1 
                // episodeInfo.innerHTML = "Staffel " + episodesCount + " | Episode " + EpisodeNumber
                // episodeInfo.style = "font-weight: 200; font-size: 1.2rem; color: rgba(110, 110, 110, 1); text-align: left;"

                // seasonContainer.appendChild(playerContainer);
                // playerContainer.appendChild(episodeInfo);

                let episodeOption = document.createElement("option");
                episodeOption.value = `media/${summary.type}/${summary.path}/${seasonNum}/${i+1}`;
                episodeOption.innerText = "Episode " + (i + 1);
                optGroup.appendChild(episodeOption);
            }

            episodeSelect.addEventListener("change", (evt) => {
                console.dir(evt);

                let episodePath = evt.srcElement.selectedOptions[0].value;      
                console.log(episodePath);

                episodePlayer.src = episodePath + ".mp4"; // TODO: get the filename from the model
                episodePlayer.onerror = function() {
                    episodePlayer.src = episodePath + ".mkv";
                };
            });

            episodeSelect.selectedIndex = 0;
            episodeSelect.dispatchEvent(new Event('change', { 'view': window, 'bubbles': true }));
        }



        let spawnPlayer = function(summary) {
            hide_player()
            document.getElementById("site-container").style.display = "none"
            playerBg.setAttribute('class', 'player');
            console.log(summary.type)
            if (summary.type == "movies"){
                seasonContainer.style.display = "none"
                document.getElementById('SeasonBorder').style.display = "none"

                player.src = 'media/' + summary.type + '/' + summary.path + '/' + summary.file;                
            } else if (summary.type == "series") {
                seasonContainer.style = "height: 150%; width: 95%; display: grid; grid-gap: 1%; grid-template-columns: 1fr 1fr 1fr 1fr; padding: 2%;"
                seasonContainer.style.display = "block"
                document.getElementById('SeasonBorder').style.display = "block"
                player.style.display = "none"

                for(let i=0; i < summary.seasons; i++){
                    let cover = document.createElement("img");
                    const seasonNum = i + 1;
                    cover.src = `media/${summary.type}/${summary.path}/meta/${seasonNum}.jpg`
                    cover.setAttribute("id", seasonNum)
                    cover.setAttribute("alt", "Staffel " + (seasonNum));
                    cover.setAttribute("class", "SeasonCover");
                    cover.setAttribute("onclick", `spawnEpisodes(${JSON.stringify(summary)}, ${seasonNum})`);
                    seasonContainer.appendChild(cover);
                }
                
            }

            playerTitle.innerHTML = summary.title;
            videoContainer.appendChild(playerTitle);
            
            playerDescription.innerHTML = summary.description;
            document.getElementById("descriptionDiv").appendChild(playerDescription);
        }

        // Thanks chat gpt duh?
        function getVideoResolution(resolutionString) {
            if (resolutionString == "[n/a]") {
                return 'Unknown Resolution';
            }

            // Extract numbers from input like "1920x1080", "1280x720 px", etc.
            const match = resolutionString.match(/(\d+)\s*x\s*(\d+)/i);
            if (!match) return 'Unknown Resolution'; // = Invalid input
          
            let width = parseInt(match[1], 10);
            let height = parseInt(match[2], 10);
          
            // Normalize for landscape orientation
            const w = Math.max(width, height);
            const h = Math.min(width, height);
          
            // aint nobody hoarding 16k 40tb .mp4 files bro
            if (h >= 4300) return 'res_8k'; 
            if (h >= 2100) return 'res_4k';
            if (h >= 1400) return 'res_1440p';
            if (h >= 1000) return 'res_1080p';
            if (h >= 700) return 'res_720p';
            if (h < 700) return 'Unknown Resolution';
          
            return 'Unknown Resolution';
        }          
          

        let createDiv = function(summary) {

            const thumbnailPath = "media/" + summary.type + "/" + summary.path + "/meta/" + summary.thumbnailFile
            
            //spawn parent div            
            let summElem = document.createElement("div");
            summElem.setAttribute('class', 'card media-item ' + summary.path);
            summElem.style = "position: relative;"
            summElem.setAttribute('onclick', `spawnPlayer(${JSON.stringify(summary)})`);

            //spawn the img div (why is this a div and not a image bruh )
            let summFilterElem = document.createElement('div');
            summFilterElem.setAttribute("class", "Filter")
            summFilterElem.style = `background-image: url('${thumbnailPath}'); background-size: cover; background-repeat: no-repeat; position: absolute; top: 0px; left: 0px;`

            //spawn the title
            let summTitleElem = document.createElement('p');
            summTitleElem.style = "font-weight: 400; font-size: 20px; text-align: left; position: absolute; bottom: 26px; left: 3px; font-family: poppins; margin: 0px;"

            if (summary.title.length > 14) {
                summTitleElem.innerText = summary.title.substring(0, 11) + "...";
            } 
            else {
                summTitleElem.innerText = summary.title;
            }
            
            //append stuff
            summElem.appendChild(summFilterElem);
            summElem.appendChild(summTitleElem);

            //spawn Episodes / Season info || Movie length
            if (summary.type === 'series'){
                let summMetaElem = document.createElement('p');
                summMetaElem.style = "font-weight: 150; color: rgba( 255, 255, 255, 0.6); text-align: left; position: absolute; bottom: 0px; left: 3px; font-family: poppins; margin: 0px; font-size: 15px;"
                summMetaElem.innerHTML = summary.seasons + ' Seasons' + (summary.seasons === '1' ? ' ' : 'n ') + ' | ' + summary.episodes + ' Episodes';
                summElem.appendChild(summMetaElem);
            }
            else if(summary.type === 'movies'){
                let summMetaElem = document.createElement('p');
                summMetaElem.style = "font-weight: 150; color: rgba( 255, 255, 255, 0.6); text-align: left; position: absolute; bottom: 0px; left: 3px; font-family: poppins; margin: 0px; font-size: 15px;"
                summMetaElem.innerHTML = '4,8' + " | " +  summary.length;
                summElem.appendChild(summMetaElem);

                // Do the resolution icon i guess

                let vidres = getVideoResolution(summary.resolution)
                console.log(summary.resolution)
                console.log(vidres)

                if (vidres != 'Unknown Resolution'){
                    let summResElem = document.createElement("img")
                    summResElem.src = 'src/' + vidres + '.png'
                    summResElem.style = "z-index: 99; width: 40px; position: absolute; bottom: 6px; left: 3px;"
                    summFilterElem.appendChild(summResElem);
            }
            }


            document.getElementById('rootContainer').appendChild(summElem);
        }

        let hide_player = function(){
                document.getElementById("site-container").style.display = "grid"
                console.log("ALAAAARRRM esc wurde gepresst");
                player.pause()
                playerBg.setAttribute('class', 'playerhidden');
                player.style.display = "inline-block";
                seasonContainer.innerHTML = '';
        }

        let loaded = function() {
            console.log('loaded');

            for (let i = 0; i < Movies.length; i++) {
                createDiv(Movies[i]);
            }

            for (let i = 0; i < Series.length; i++){
                createDiv(Series[i]);
            }

            chooseTopPick(Movies)
        }

        //fancy for if(esc pressed){hide player}
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' || event.key === 'Esc') {
                hide_player()
            }
        });
        
        loaded();
        
        
        
        let filter = function(value) {
            console.log('filtering by ' + value);
            
            if (value.length === 0) {
                resetFilter();
                return;
            }
            
            const lowValue = value.toLowerCase();
            
            for (let movie of Movies) {
                if (movie.title.toLowerCase().indexOf(lowValue) === -1) {
                    document.querySelector("." + movie.path).style.display = "none";
                }
            }

            for (let serie of Series){
                if (serie.title.toLowerCase().indexOf(lowValue) === -1) {
                    document.querySelector("." + serie.path).style.display = "none";
                }
            }
        }
        
        let resetFilter = function() {
            for (let mediaItem of document.querySelectorAll(".media-item")) {
                mediaItem.style.display = "block";
            }
        }


        let filterType = function(Type) {
            
            
            if (Type == "Movies") {

                document.getElementById("searchbar_button_movies").style.color = "white"
                document.getElementById("searchbar_button_series").style.color = "#CACACA"
                document.getElementById("searchbar_button_audios").style.color = "#CACACA"

                for (let mediaItem of document.querySelectorAll(".media-item")) {
                    mediaItem.style.display = "block";
                }

                for (let serie of Series) {
                    document.querySelector("." + serie.path).style.display = "none";
                }
            }
            
            if (Type == "Series") {

                document.getElementById("searchbar_button_movies").style.color = "#CACACA"
                document.getElementById("searchbar_button_series").style.color = "white"
                document.getElementById("searchbar_button_audios").style.color = "#CACACA"

                for (let mediaItem of document.querySelectorAll(".media-item")) {
                    mediaItem.style.display = "block";
                }

                for (let movie of Movies) {
                    document.querySelector("." + movie.path).style.display = "none";
                }
            }

            // TODO: Audios
            /*
            if (Type == "Audios") {
                for (let movie of Movies) {
                    document.querySelector("." + movie.path).style.display = "none";
                }
                for (let serie of Series) {
                    document.querySelector("." + serie.path).style.display = "none";  
                }

            }
            */

        }

    </script>


</html>